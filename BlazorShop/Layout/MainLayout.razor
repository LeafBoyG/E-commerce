@inherits LayoutComponentBase
@using BlazorShop.Services
@using BlazorShop.Layout
@using Microsoft.AspNetCore.Components.Authorization
@inject CartService CartService
@implements IDisposable

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <div class="auth-links">
                <AuthorizeView>
                    <Authorized>
                        <span class="welcome-msg">Hello, @context.User.Identity?.Name!</span>
                        <button class="btn-login" @onclick="Logout">Logout</button>
                    </Authorized>
                    <NotAuthorized>
                        <button class="btn-login" @onclick="Login">Login Demo</button>
                    </NotAuthorized>
                </AuthorizeView>
            </div>

            <a href="/cart" class="cart-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                
                @if (CartService.CartItems.Count > 0)
                {
                    <span class="cart-badge">@CartService.CartItems.Count</span>
                }
            </a>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<BlazorShop.Layout.ToastNotification />

@code {
    [Inject] AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // 1. Listen for changes
        CartService.OnChange += StateHasChanged;

        // 2. Load saved cart data immediately
        await CartService.LoadCartAsync();
    }

    private void Login()
    {
        var customAuthProvider = (CustomAuthStateProvider)AuthStateProvider;
        customAuthProvider.Login("customer@example.com");
    }

    private void Logout()
    {
        var customAuthProvider = (CustomAuthStateProvider)AuthStateProvider;
        customAuthProvider.Logout();
    }

    public void Dispose()
    {
        CartService.OnChange -= StateHasChanged;
    }
}